<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title> Chat Demo </title>
<meta name="Generator" content="EditPlus">
<meta name="Author" content="">
<meta name="Keywords" content="">
<meta name="Description" content="">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<style type="text/css">
h3{color:red;}
body{color:#666;}
ul li{list-style:none;}
ul li textarea{width:100%;}
#msg_list{width:100%; border:1px solid #ccc;}
#sendBtn{margin-left:auto; margin-right:auto; display:block;}
.tip{font-size:12px; color: #ccc;}

#main_left{float: left; width: 70%;}
#main_right{float: left; width: 20%;}
</style>
</head>

<body>
<script src="http://nodejs.t.com:8000/socket.io/socket.io.js"></script>
<script type="text/javascript">
// init
var socket = io.connect('http://nodejs.t.com:8000');
var conn = false;

socket.on('ready', function(data){
	if (data.msg == 'OK') {
		conn = true;
	} else {
		document.write('连接服务器失败.');
		return false;
	}
});

socket.on('welcome', function(data){
	$('#name_wrap').hide();
	$('#main_wrap').show();
	$('#main_left h3').html(data.name);
});

socket.on('recive', function(data){
	var winH = $(window).height();
	var msgH = $('#main_wrap').height();
	$('#msg_list').append('<p>&lt;' + data.from + '&gt;<br />&nbsp;&nbsp;' + data.text + '</p>').last('p').hide();
	var newH = parseInt(msgH, 10) + parseInt($('#msg_list p:last').height(), 10);
	if (newH >= winH) {
		$('#msg_list').css({'height':msgH})
	}
	$('#msg_list p:last').show();
});


$().ready(function(){
	$('#nameBtn').click(function(){
		var uname = $('#nameInput').val();
		if (uname.length > 0) {
			socket.emit('setname', { name: uname});
		}
	})
	$('#sendBtn').click(function(){
		var msg = $('#msgInput').val();
		if (msg.length > 0) {
			socket.emit('send', {'from': $('#main_left h3').text(), 'sendTo': '', 'text': msg});
			$('#msgInput').val('');
		} else {
			alert('请输入要发送的内容！');
			return false;
		}
	})
})
</script>

<div id="name_wrap">
	<input type="text" id="nameInput"><input type="button" value="确定" id="nameBtn"><span class="tip">请先输入你的昵称</span>
</div>

<div id="main_wrap" style="display:none;">
	<ul id="main_left">
		<li><h3>--</h3></li>
		<li id="msg_list"></li>
		<li><textarea rows="3" cols="45" id="msgInput"></textarea></li>
		<li><input type="button" value="发送" id="sendBtn"></li>
	</ul>
	<ul id="main_right">
		<li>--</li>
	</ul>
	<div style="clear:both;"></div>
</div>

</body>
</html>
